<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scheduler - Agent Staffing Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .controls {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            flex: 1;
            min-width: 200px;
        }

        label {
            font-weight: 600;
            color: #333;
            font-size: 0.95rem;
        }

        input[type="file"],
        input[type="number"] {
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 1rem;
        }

        input[type="file"]:hover,
        input[type="number"]:hover {
            border-color: #667eea;
        }

        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 40px;
            overflow: visible;
        }

        .hour-cell {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            z-index: 1;
        }

        .hour-cell:hover {
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2);
        }

        .hour-label {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .agent-count {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
        }

        #globalTooltip {
            position: fixed;
            background: #333;
            color: white;
            padding: 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            min-width: 180px;
            z-index: 10000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            pointer-events: none;
            max-width: 250px;
            word-wrap: break-word;
        }

        .export-buttons {
            text-align: center;
            margin-top: 20px;
        }

        .export-buttons button {
            margin: 0 10px;
        }

        .legend {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .legend h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .legend-box {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: white;
        }

        .empty-state p {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .empty-state .hint {
            font-size: 0.95rem;
            opacity: 0.8;
        }

        .schedule-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .controls {
                flex-direction: column;
            }

            .input-group {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ“Š Scheduler</h1>
            <p>AI Agent Staffing Calculator</p>
        </header>

        <div class="controls">
            <div class="input-group">
                <label for="csv-upload">Upload CSV:</label>
                <input type="file" id="csv-upload" accept=".csv">
            </div>

            <div class="input-group">
                <label for="utilization">Utilization:</label>
                <input type="number" id="utilization" min="0.1" max="5" step="0.1" value="1.0">
            </div>

            <button id="downloadBtn" style="display: none;">ðŸ“¥ Download JSON</button>
        </div>

        <div id="error" class="error"></div>

        <div id="emptyState" class="empty-state">
            <p>ðŸ‘† Upload a CSV to get started</p>
            <p class="hint">Format: CustomerName, Duration, StartTime, EndTime, Calls, Priority</p>
        </div>

        <div id="schedule" class="schedule-container" style="display: none;">
            <div id="globalTooltip" class="tooltip" style="display: none;"></div>
            <div class="grid" id="grid"></div>

            <div class="export-buttons">
                <button onclick="exportJSON()">ðŸ“¥ JSON</button>
                <button onclick="exportCSV()">ðŸ“¥ CSV</button>
            </div>

            <div class="legend">
                <h3>Color Legend (Total Agents)</h3>
                <div class="legend-row"><div class="legend-box" style="background: #f0f0f0;"></div><span>0 agents</span></div>
                <div class="legend-row"><div class="legend-box" style="background: #fff3cd;"></div><span>&lt;100</span></div>
                <div class="legend-row"><div class="legend-box" style="background: #ffe5b4;"></div><span>100-500</span></div>
                <div class="legend-row"><div class="legend-box" style="background: #ffccb3;"></div><span>500-1000</span></div>
                <div class="legend-row"><div class="legend-box" style="background: #ffb3b3;"></div><span>1000+</span></div>
            </div>
        </div>
    </div>

    <script>
        let scheduleData = null;

        function parseTime(timeStr) {
            const match = timeStr.trim().toUpperCase().match(/^(\d{1,2})(?::(\d{2}))?\s*(AM|PM)$/);
            if (!match) return -1;

            let hour = parseInt(match[1]);
            const period = match[3];

            if (hour < 1 || hour > 12) return -1;

            if (period === 'AM') {
                if (hour === 12) hour = 0;
            } else {
                if (hour !== 12) hour += 12;
            }

            return hour;
        }

        function calculateAgents(calls, duration, hoursSpanned, utilization) {
            if (hoursSpanned === 0) return 0;
            const callsPerHour = calls / hoursSpanned;
            const agentsPerHour = (callsPerHour * duration) / 3600;
            return Math.ceil(agentsPerHour * utilization);
        }

        function getColor(agents) {
            if (agents === 0) return '#f0f0f0';
            if (agents < 100) return '#fff3cd';
            if (agents < 500) return '#ffe5b4';
            if (agents < 1000) return '#ffccb3';
            return '#ffb3b3';
        }

        document.getElementById('csv-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(event) {
                try {
                    const csv = event.target.result;
                    const lines = csv.trim().split('\n');
                    const headers = lines[0].split(',').map(h => h.trim());

                    const schedule = {};
                    for (let i = 0; i < 24; i++) {
                        schedule[i] = { total: 0, perCustomer: {} };
                    }

                    const utilization = parseFloat(document.getElementById('utilization').value) || 1.0;

                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        if (values.length < 6 || !values[0]) continue;

                        const name = values[0];
                        const duration = parseInt(values[1]);
                        const startTime = parseTime(values[2]);
                        const endTime = parseTime(values[3]);
                        const calls = parseInt(values[4]);

                        if (startTime < 0 || endTime < 0) {
                            throw new Error(`Invalid time format in row ${i + 1}`);
                        }

                        const hoursSpanned = endTime - startTime;
                        const agents = calculateAgents(calls, duration, hoursSpanned, utilization);

                        for (let h = startTime; h < endTime; h++) {
                            schedule[h].perCustomer[name] = agents;
                            schedule[h].total += agents;
                        }
                    }

                    scheduleData = schedule;
                    renderSchedule();
                    document.getElementById('emptyState').style.display = 'none';
                    document.getElementById('schedule').style.display = 'block';
                    document.getElementById('error').classList.remove('show');

                } catch (err) {
                    document.getElementById('error').textContent = 'âŒ ' + err.message;
                    document.getElementById('error').classList.add('show');
                }
            };
            reader.readAsText(file);
        });

        document.getElementById('utilization').addEventListener('change', function() {
            const upload = document.getElementById('csv-upload');
            if (upload.files.length > 0) {
                upload.dispatchEvent(new Event('change'));
            }
        });

        function renderSchedule() {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            const globalTooltip = document.getElementById('globalTooltip');

            for (let h = 0; h < 24; h++) {
                const data = scheduleData[h];
                const bgColor = getColor(data.total);

                const cell = document.createElement('div');
                cell.className = 'hour-cell';
                cell.style.backgroundColor = bgColor;

                const customers = Object.entries(data.perCustomer)
                    .sort(([a], [b]) => a.localeCompare(b));

                cell.innerHTML = `
                    <div class="hour-label">${String(h).padStart(2, '0')}:00</div>
                    <div class="agent-count">${data.total}</div>
                `;

                // Add hover event listeners
                cell.addEventListener('mouseenter', function(e) {
                    const rect = this.getBoundingClientRect();
                    
                    // Build tooltip content
                    let tooltipHTML = '';
                    if (customers.length > 0) {
                        tooltipHTML = '<div style="font-weight: 600; border-bottom: 1px solid #555; padding-bottom: 4px; margin-bottom: 4px;">Breakdown:</div>';
                        customers.forEach(([name, agents]) => {
                            tooltipHTML += `<div style="text-align: left; padding: 3px 0; border-bottom: 1px solid #555; margin-bottom: 3px;">${name}: <strong>${agents}</strong></div>`;
                        });
                    } else {
                        tooltipHTML = '<div style="text-align: left;">No breakdown</div>';
                    }
                    
                    globalTooltip.innerHTML = tooltipHTML;
                    globalTooltip.style.display = 'block';
                    
                    // Position tooltip
                    const idealLeft = rect.left + rect.width / 2;
                    const idealTop = rect.top - 10;
                    
                    let left = idealLeft;
                    let top = idealTop;
                    let transformY = '-100%'; // Default: above
                    
                    // Check bounds
                    const padding = 10;
                    const maxTooltipWidth = 250;
                    
                    // Right edge check
                    if (left + maxTooltipWidth / 2 > window.innerWidth - padding) {
                        left = window.innerWidth - maxTooltipWidth / 2 - padding;
                    }
                    
                    // Left edge check
                    if (left - maxTooltipWidth / 2 < padding) {
                        left = maxTooltipWidth / 2 + padding;
                    }
                    
                    // Top edge check
                    if (top < 150) { // Estimated tooltip height
                        top = rect.bottom + 10;
                        transformY = '0'; // Below
                    }
                    
                    globalTooltip.style.left = left + 'px';
                    globalTooltip.style.top = top + 'px';
                    globalTooltip.style.transform = `translate(-50%, ${transformY})`;
                });

                cell.addEventListener('mouseleave', function(e) {
                    globalTooltip.style.display = 'none';
                });

                grid.appendChild(cell);
            }
        }

        function exportJSON() {
            const data = {
                config: { utilization: parseFloat(document.getElementById('utilization').value) },
                schedule: Object.entries(scheduleData).map(([h, d]) => ({
                    hour: parseInt(h),
                    hour_str: `${String(h).padStart(2, '0')}:00`,
                    total_agents: d.total,
                    per_customer: d.perCustomer
                }))
            };

            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schedule.json';
            a.click();
        }

        function exportCSV() {
            const allCustomers = new Set();
            Object.values(scheduleData).forEach(d => {
                Object.keys(d.perCustomer).forEach(c => allCustomers.add(c));
            });

            const customers = Array.from(allCustomers).sort();
            let csv = 'Hour,Total,' + customers.join(',') + '\n';

            for (let h = 0; h < 24; h++) {
                const d = scheduleData[h];
                const row = [
                    `${String(h).padStart(2, '0')}:00`,
                    d.total,
                    ...customers.map(c => d.perCustomer[c] || '')
                ];
                csv += row.join(',') + '\n';
            }

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'schedule.csv';
            a.click();
        }
    </script>
</body>
</html>
